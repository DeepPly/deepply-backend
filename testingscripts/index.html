<h1>Create User</h1>
<form id="createUserForm">
    <label for="username">Username:</label>
    <input type="text" id="username" name="username" required>
    <br><br>
    <label for="password">Password:</label>
    <input type="password" id="password" name="password" minlength="8" required>
    <br><br>
    <label for="email">Email:</label>
    <input type="email" id="email" name="email" required>
    <br><br>
    <button type="submit">Create User</button>
</form>
<form id="loginForm">
    <label for="loginUsername">Username:</label>
    <input type="text" id="loginUsername" name="username" required>
    <br><br>
    <label for="loginPassword">Password:</label>
    <input type="password" id="loginPassword" name="password" minlength="8" required>
    <br><br>
    <button type="submit">Login</button>
</form>
<h1>Upload Game</h1>
<form id="uploadGameForm">
    <label for="user_color">User Color (true=White, false=Black):</label>
    <select id="user_color" name="user_color" required>
        <option value="true">White</option>
        <option value="false">Black</option>
    </select>
    <br><br>
    <label for="pgn">PGN:</label>
    <textarea id="pgn" name="pgn" rows="6" cols="40" required></textarea>
    <br><br>
    <label for="time_control">Time Control:</label>
    <input type="text" id="time_control" name="time_control" required>
    <br><br>
    <label for="game_type">Game Type:</label>
    <input type="text" id="game_type" name="game_type" required>
    <br><br>
    <label for="description">Description:</label>
    <input type="text" id="description" name="description">
    <br><br>
    <label for="opponent_rating">Opponent Rating (optional):</label>
    <input type="number" id="opponent_rating" name="opponent_rating">
    <br><br>
    <label for="result">Result:</label>
    <input type="text" id="result" name="result" required>
    <br><br>
    <button type="submit">Upload Game</button>
</form>

<script>
document.getElementById('uploadGameForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const data = {
        user_color: document.getElementById('user_color').value === "true",
        pgn: document.getElementById('pgn').value,
        time_control: document.getElementById('time_control').value,
        game_type: document.getElementById('game_type').value,
        description: document.getElementById('description').value,
        opponent_rating: document.getElementById('opponent_rating').value ? parseInt(document.getElementById('opponent_rating').value) : null,
        result: document.getElementById('result').value
    };
    const response = await fetch('http://127.0.0.1:8000/upload_game', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
        },
        body: JSON.stringify(data)
    });
    const result = await response.json();
    console.log(result);
});

document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const data = {
        username: document.getElementById('loginUsername').value,
        password: document.getElementById('loginPassword').value
    }
    fetch('http://127.0.0.1:8000/token', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams(data)
    }).then(response => response.json()).then(data => {
        console.log(data);
        localStorage.setItem('access_token', data.access_token);
    });
})

document.getElementById('createUserForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const data = {
        username: document.getElementById('username').value,
        password: document.getElementById('password').value,
        email: document.getElementById('email').value
    };
    const response = await fetch('http://127.0.0.1:8000/create_user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    const result = await response.json();
    alert(JSON.stringify(result));
});


function protected(){
    if (localStorage.getItem('access_token')) {
        let good = false;
        fetch('http://127.0.0.1:8000/protected', {
            headers: {'Authorization': `Bearer ${localStorage.getItem('access_token')}`}
        })
        .then(data => {
            if (data.status === 401) {
                alert("Unauthorized");
            } else {
                good = true;
                return data.json();
            }
        }).then(data => {
            if (good) {
                alert(JSON.stringify(data));
            }
        }).catch(err => {
            console.error(err);
            alert("Error accessing protected route");
        });
    } else{
        alert("No access token")
    }
}
</script>